name: Build ASP.NET 4.7.1 solution

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v2

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.0.2

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1.0.5

    - name: Restore NuGet packages
      run: nuget restore MyCRM.sln

    - name: Build solution
      run: msbuild MyCRM.sln /p:Configuration=Debug 

    - name: Read Contents
      run: dir
    - name: Change Directory
      run: cd MyPlugins/bin/Debug
    - name: Read Contents
      run: dir
    - name: Authenticate with source environment
      uses: microsoft/powerplatform-actions/who-am-i@v0
      with:
        environment-url: ${{ secrets.CRM_URL }}
        app-id: ${{ secrets.CRM_APP_ID }}
        client-secret: ${{ secrets.CRM_CLIENT_SECRET }}
        tenant-id: ${{ secrets.CRM_TENANT_ID }}

    - name: Push to CRM
      uses: microsoft/powerplatform-actions/deploy-package@v0
      with:
        environment-url: ${{ secrets.CRM_URL }}
        app-id: ${{ secrets.CRM_APP_ID }}
        client-secret: ${{ secrets.CRM_CLIENT_SECRET }}
        tenant-id: ${{ secrets.CRM_TENANT_ID }}
        package: ./MyPlugins.dll


        

   
